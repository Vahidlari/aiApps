name: Milestone-Driven Release

on:
  milestone:
    types: [closed]

jobs:
  check-milestone:
    if: github.ref_name == 'main'
    runs-on: ubuntu-latest
    outputs:
      milestone_title: ${{ steps.get_milestone.outputs.title }}
      milestone_number: ${{ steps.get_milestone.outputs.number }}
      has_release_commits: ${{ steps.check_commits.outputs.has_release_commits }}
      last_tag: ${{ steps.get_last_tag.outputs.tag }}
      release_branch: ${{ steps.determine_branch.outputs.branch }}
    steps:
      - name: Determine release branch
        id: determine_branch
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Release branch: $BRANCH"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.determine_branch.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_GH_TOKEN }}

      - name: Get milestone information
        id: get_milestone
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GH_TOKEN }}
        run: |
          MILESTONE_TITLE="${{ github.event.milestone.title }}"
          MILESTONE_NUMBER="${{ github.event.milestone.number }}"

          echo "title=$MILESTONE_TITLE" >> $GITHUB_OUTPUT
          echo "number=$MILESTONE_NUMBER" >> $GITHUB_OUTPUT
          echo "Milestone: $MILESTONE_TITLE (#$MILESTONE_NUMBER)"

      - name: Get last tag
        id: get_last_tag
        run: |
          BRANCH="${{ steps.determine_branch.outputs.branch }}"
          # Try to get the last tag from the current branch
          LAST_TAG=$(git describe --tags --abbrev=0 "$BRANCH" 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "Last tag: $LAST_TAG (from branch: $BRANCH)"

      - name: Check for release-worthy commits
        id: check_commits
        run: |
          BRANCH="${{ steps.determine_branch.outputs.branch }}"
          if bash tools/release-scripts/check-release-commits.sh "${{ steps.get_last_tag.outputs.tag }}" "$BRANCH"; then
            echo "has_release_commits=true" >> $GITHUB_OUTPUT
          else
            echo "has_release_commits=false" >> $GITHUB_OUTPUT
          fi

  production-release:
    needs: check-milestone
    if: needs.check-milestone.outputs.has_release_commits == 'true'
    permissions:
      contents: write
      packages: write
      issues: read
      pull-requests: read
    uses: ./.github/workflows/release-core.yml
    secrets:
      PERSONAL_GH_TOKEN: ${{ secrets.PERSONAL_GH_TOKEN }}
      PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
      TEST_PYPI_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}
    with:
      release_type: production
      branch: ${{ needs.check-milestone.outputs.release_branch }}
      milestone_title: ${{ needs.check-milestone.outputs.milestone_title }}
      publish_to_pypi: true
      use_test_pypi: false

  no-release-needed:
    needs: check-milestone
    if: needs.check-milestone.outputs.has_release_commits == 'false'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Comment on milestone
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GH_TOKEN }}
        run: |
          MILESTONE_NUMBER="${{ needs.check-milestone.outputs.milestone_number }}"

          # Create a comment on the milestone
          LAST_TAG="${{ needs.check-milestone.outputs.last_tag }}"
          MILESTONE_TITLE="${{ needs.check-milestone.outputs.milestone_title }}"
          COMMENT_BODY=$(printf "%s\n\n%s\n\n%s\n\n%s\n%s\n%s\n%s" \
            "ðŸš« **No Release Needed**" \
            "This milestone was closed, but no version bump was required because there were no release-worthy commits since the last tag (${LAST_TAG})." \
            "**Milestone:** ${MILESTONE_TITLE}" \
            "To trigger a release, ensure your commits follow [Conventional Commits](https://www.conventionalcommits.org/) format:" \
            "- \`feat:\` for new features (minor version bump)" \
            "- \`fix:\` for bug fixes (patch version bump)" \
            "- \`BREAKING CHANGE:\` for breaking changes (major version bump)")

          gh api repos/${{ github.repository }}/issues \
            --jq '.[] | select(.milestone.number == '$MILESTONE_NUMBER') | .number' \
            --paginate | head -1 | while read ISSUE_NUMBER; do
            if [ -n "$ISSUE_NUMBER" ]; then
              gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
                --method POST \
                --field body="$COMMENT_BODY"
              break
            fi
          done
