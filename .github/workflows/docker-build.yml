name: Build and Push Docker Image

on:
  # Trigger when update-dependencies workflow completes successfully
  workflow_run:
    workflows: ["Update Dependencies"]
    types: [completed]
    branches: [main]
  # Also trigger on direct changes to Docker files (not Pipfile)
  push:
    branches: [main]
    paths:
      - "tools/docker/Dockerfile"
      - ".github/workflows/docker-build.yml"
  pull_request:
    branches: [main]
    paths:
      - "tools/docker/**"
      - ".github/workflows/docker-build.yml"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ai-dev

jobs:
  build:
    runs-on: ubuntu-latest
    # Only run if update-dependencies workflow succeeded OR if no Pipfile was modified
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push' && !contains(github.event.head_commit.modified, 'tools/docker/Pipfile')) ||
      github.event_name == 'pull_request'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for race condition
        if: github.event_name == 'push'
        run: |
          if echo "${{ github.event.head_commit.modified }}" | grep -q "tools/docker/Pipfile"; then
            echo "ðŸš¨ RACE CONDITION DETECTED!"
            echo "Pipfile was modified in this push. The 'Update Dependencies' workflow should handle this."
            echo "This workflow will exit to avoid building with outdated dependencies."
            echo "The docker build will be triggered automatically after dependencies are updated."
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        run: echo "${{ secrets.ClassicTokenForRegisteryAccess }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Generate date tag
        id: date-tag
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.run_number }},enable={{is_default_branch}}
            type=raw,value=${{ steps.date-tag.outputs.date }},enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./tools/docker
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
