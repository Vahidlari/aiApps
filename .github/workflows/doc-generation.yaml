name: Generate Documentation

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      SITE_OUTPUT_DIR: ${{ github.workspace }}/.site-build
    steps:
      - name: Check out release tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure default branch fallback
        run: |
          if [ -z "${DEFAULT_BRANCH}" ]; then
            echo "DEFAULT_BRANCH=main" >> "$GITHUB_ENV"
          else
            echo "DEFAULT_BRANCH=${DEFAULT_BRANCH}" >> "$GITHUB_ENV"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ragora/pyproject.toml', 'ragora/requirements-dev.txt', 'mkdocs.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e "ragora[docs]"

      - name: Build MkDocs site
        run: mkdocs build

      - name: Preserve built site
        run: |
          rm -rf "${SITE_OUTPUT_DIR}"
          mkdir -p "${SITE_OUTPUT_DIR}"
          rsync -a docs/ "${SITE_OUTPUT_DIR}/"

      - name: Switch to default branch
        run: |
          git fetch origin "${DEFAULT_BRANCH}"
          git checkout "${DEFAULT_BRANCH}"
          git reset --hard "origin/${DEFAULT_BRANCH}"

      - name: Restore site into docs directory
        run: |
          rsync -a --delete "${SITE_OUTPUT_DIR}/" docs/

      - name: Commit updated documentation
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update site for ${{ github.ref_name }}"
          file_pattern: docs/**
