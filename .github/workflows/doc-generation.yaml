name: Generate Documentation

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      SITE_OUTPUT_DIR: ${{ github.workspace }}/.site-build
    steps:
      - name: Check out release tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Ensure default branch fallback
        run: |
          if [ -z "${DEFAULT_BRANCH}" ]; then
            echo "DEFAULT_BRANCH=main" >> "$GITHUB_ENV"
          else
            echo "DEFAULT_BRANCH=${DEFAULT_BRANCH}" >> "$GITHUB_ENV"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ragora/pyproject.toml', 'ragora/requirements-dev.txt', 'mkdocs.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Extract version from git tag
        id: extract_version
        run: |
          # First, try to get the tag that HEAD points to (for release events)
          TAG_NAME=$(git describe --tags --exact-match HEAD 2>/dev/null || git tag --points-at HEAD | head -n 1)

          # If no tag at HEAD, get the latest tag from the repository (for manual dispatch or branches)
          if [ -z "${TAG_NAME}" ]; then
            echo "No tag found at HEAD, fetching latest tag..."
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || git tag --sort=-version:refname | head -n 1)
          fi

          if [ -z "${TAG_NAME}" ]; then
            echo "Error: No git tag found in repository. Cannot determine version." >&2
            exit 1
          fi

          # Extract version from tag (e.g., v1.3.0 -> 1.3.0)
          VERSION="${TAG_NAME#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Extracted version: ${VERSION} from git tag: ${TAG_NAME}"

      - name: Install documentation dependencies
        env:
          SETUPTOOLS_SCM_PRETEND_VERSION: ${{ env.VERSION }}
        run: |
          python -m pip install --upgrade pip
          pip install -e "ragora[docs]"

      - name: Build MkDocs site
        run: mkdocs build

      - name: Preserve built site
        run: |
          rm -rf "${SITE_OUTPUT_DIR}"
          mkdir -p "${SITE_OUTPUT_DIR}"
          rsync -a docs/ "${SITE_OUTPUT_DIR}/"

      - name: Switch to default branch
        run: |
          git fetch origin "${DEFAULT_BRANCH}"
          git checkout "${DEFAULT_BRANCH}"
          git reset --hard "origin/${DEFAULT_BRANCH}"

      - name: Restore site into docs directory
        run: |
          rsync -a --delete "${SITE_OUTPUT_DIR}/" docs/

      - name: Commit updated documentation
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update site for ${{ github.ref_name }}"
          file_pattern: docs/**
